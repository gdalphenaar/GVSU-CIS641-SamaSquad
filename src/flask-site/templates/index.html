<!-- based on https://github.com/stlehmann/Flask-MQTT/tree/master/example from the author of Flask-MQTT -->
{% extends 'components/base.html' %}
{% block scripts %}
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
<script type="text/javascript" charset="utf-8">
  $(document).ready(function() {
    var socket = io.connect('http://' + document.domain + ':' + location.port);

    // subscribe to a topic
    $('#subscribe').click(function(event) {
      var topic = $('#subscribe_topic').val();
      var qos = $('#subscribe_qos').val();
      var data = '{"topic": "' + topic + '", "qos": ' + 1 + '}';
      socket.emit('subscribe', data=data);
      $('#subscribe').hide();
      $('#unsubscribe').show();
      $('#subscribe_topic').prop('readonly', true);
    });

    // unsubscribe from a topic
    $('#unsubscribe').click(function(event) {
      socket.emit('unsubscribe_all');
      $('#subscribe').show();
      $('#unsubscribe').hide();
      $('#subscribe_topic').prop('readonly', false);
    });

    // get a new message
    {% for s in sensors %}
      socket.on('mqtt_message', function(data) {
        var message = JSON.parse(data['payload'])
        // var t = message.sensor.concat("_temp")
        document.getElementById(message.sensor.concat("_temp")).innerHTML = message.temp.toFixed(2)
        document.getElementById(message.sensor.concat("_humd")).innerHTML = message.humd.toFixed(2);
        // document.getElementById({{ sensor }}).innerHTML = message.name;
      })
    {% endfor %}
  });
</script>
{% endblock %}

{% block content %}
<div class="container">
  {% for sensor in sensors %}
    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title" id="title">{{ sensor }}</h3>
      </div>
      <div class="panel-body">
        <p>Temperature:</p>
        <p id="{{ sensor }}_temp"><br/></p>
        <p>Humidity</p>
        <p id="{{ sensor }}_humd"><br/></p>
      </div>
    </div>
  {% endfor %}
</div>
{% endblock %}