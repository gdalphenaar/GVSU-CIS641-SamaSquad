<!-- based on https://github.com/stlehmann/Flask-MQTT/tree/master/example from the author of Flask-MQTT -->
{% extends 'components/base.html' %}

{% block scripts %}
{{ super() }}
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
<script type="text/javascript" charset="utf-8">
  $(document).ready(function() {
    var socket = io.connect('http://' + document.domain + ':' + location.port);

    // subscribe to a topic
    document.getElementById("subscribe").onclick = function() {
      var sensor = $('#sensor_id').val();
      var name = $('#sensor_name').val();
      // new_sensor = {"id":sensor, "name":name};
      var new_sensor = '{"id": "' + sensor + '", "name": "' + name + '"}';
      console.log(new_sensor);
      socket.emit('subscribe', data=new_sensor)
    }

    // unsubscribe from a topic
    {% for sensor in sensors %}
      document.getElementById("{{ sensor.id }}_unsub").onclick = function() {
        var panel = document.getElementById("{{ sensor.id }}");
        panel.remove();
        socket.emit('unsubscribe', sensor = "{{ sensor.id }}")
      };
    {% endfor %}
  });
</script>
{% endblock %}

{% block content %}
<div class="container">
  <div class="panel panel-default">
    <div class="panel-heading">
      <h3 class="panel-title">Add New</h3>
    </div>
    <div class="panel-body">
      <div class="form-group">
        <label class="control-label col-xs-4">Sensor ID: </label>
        <div class="col-xs-8">
          <input id="sensor_id" class="form-control">
        </div>
      </div>
      <br/><br/>
      <div class="form-group">
        <label class="control-label col-xs-4">Sensor Name: </label>
        <div class="col-xs-8">
          <input id="sensor_name" class="form-control">
        </div>
      </div>
      <br/><br/>
      <div class="col-xs-8 col-xs-offset-4">
        <button id="subscribe" class="btn">Subscribe</button>
      </div>
    </div>
  </div>
  {% for sensor in sensors %}
    <div class="panel panel-default" id="{{ sensor.id }}">
      <div class="panel-heading">
        <h3 class="panel-title" id="title">{{ sensor.name }}</h3>
        <p>{{sensor.id}}</p>
      </div>
      <div class="panel-body">
        <div class="form-group">
          <div class="col-xs-8 col-xs-offset-4">
            <button id="{{ sensor.id }}_unsub" class="btn">Unsubscribe</button>
          </div>
        </div>
      </div>
    </div>
  {% endfor %}
</div>
{% endblock %}