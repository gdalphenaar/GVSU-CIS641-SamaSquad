<!-- based on https://github.com/stlehmann/Flask-MQTT/tree/master/example from the author of Flask-MQTT -->
{% extends 'components/base.html' %}

{% block scripts %}
{{ super() }}
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
<script type="text/javascript" charset="utf-8">
  $(document).ready(function() {
    var socket = io.connect('http://' + document.domain + ':' + location.port);

    // subscribe to a topic
    $('#subscribe').click(function(event) {
      var topic = $('#subscribe_topic').val();
      var qos = $('#subscribe_qos').val();
      var data = '{"topic": "' + topic + '", "qos": ' + 1 + '}';
      socket.emit('subscribe', data=data);
      $('#subscribe').hide();
      $('#unsubscribe').show();
      $('#subscribe_topic').prop('readonly', true);
    });

    // unsubscribe from a topic
    {% for sensor in sensors %}
      document.getElementById("{{ sensor.id }}_unsub").onclick = function() {
        var panel = document.getElementById("{{ sensor.id }}");
        panel.remove();
        socket.emit('unsubscribe', sensor = "{{ sensor.id }}")
      };
    {% endfor %}
  });
</script>
{% endblock %}

{% block content %}
<div class="container">
  <div class="panel panel-default">
    <div class="panel-heading">
      <h3 class="panel-title">Add New</h3>
    </div>
    <div class="panel-body">
  </div>
</div>
  {% for sensor in sensors %}
    <div class="panel panel-default" id="{{ sensor.id }}">
      <div class="panel-heading">
        <h3 class="panel-title" id="title">{{ sensor.name }}</h3>
      </div>
      <div class="panel-body">
        <div class="form-group">
          <div class="col-xs-8 col-xs-offset-4">
            <button id="{{ sensor.id }}_unsub" class="btn">Unsubscribe</button>
          </div>
        </div>
      </div>
    </div>
  {% endfor %}
</div>
{% endblock %}